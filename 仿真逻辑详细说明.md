# å®‰æ£€ä»¿çœŸç³»ç»Ÿè¯¦ç»†é€»è¾‘è¯´æ˜

## æ¦‚è¿°

è¿™ä¸ªä»¿çœŸç³»ç»ŸåŸºäº**SimPyç¦»æ•£äº‹ä»¶ä»¿çœŸæ¡†æ¶**ï¼Œæ¨¡æ‹Ÿ35,000åè§‚ä¼—åœ¨3.5å°æ—¶å†…é€šè¿‡å®‰æ£€è¿›ç«™çš„å®Œæ•´è¿‡ç¨‹ã€‚ç³»ç»Ÿé€šè¿‡ç²¾ç¡®å»ºæ¨¡æ¯ä¸ªè§‚ä¼—çš„å®Œæ•´æ—…ç¨‹ï¼Œä¸ºå¤§å‹æ´»åŠ¨å®‰æ£€è§„åˆ’æä¾›ç§‘å­¦çš„å†³ç­–æ”¯æŒã€‚

---

## ğŸ—ï¸ 1. æ ¸å¿ƒæ¶æ„

### 1.1 SpectatorStatsç±» - è§‚ä¼—æ•°æ®è®°å½•å™¨

æ¯ä¸ªè§‚ä¼—éƒ½æœ‰ä¸€ä¸ªä¸“å±çš„æ•°æ®è®°å½•å™¨ï¼Œè¿½è¸ªå…¶åœ¨ä»¿çœŸè¿‡ç¨‹ä¸­æ¯ä¸ªç¯èŠ‚çš„è¯¦ç»†æ—¶é—´æ•°æ®ï¼š

```python
class SpectatorStats:
    def __init__(self, id, arrival_time):
        self.id = id                          # è§‚ä¼—å”¯ä¸€æ ‡è¯†
        self.arrival_time = arrival_time      # åˆ°è¾¾å…¬å›­æ—¶é—´
        self.transport_delay = 0              # äº¤é€šå»¶è¿Ÿæ—¶é—´
        self.walk_duration = 0                # æ­¥è¡Œè€—æ—¶
        self.security_queue_wait_time = 0     # å®‰æ£€æ’é˜Ÿç­‰å¾…æ—¶é—´
        self.security_process_time = 0        # å®‰æ£€å¤„ç†æ—¶é—´
        self.descend_queue_wait_time = 0      # ä¸‹æ¥¼æ’é˜Ÿç­‰å¾…æ—¶é—´
        self.descend_process_time = 0         # ä¸‹æ¥¼è¿‡ç¨‹æ—¶é—´
        self.descend_method = ""              # ä¸‹è¡Œæ–¹å¼é€‰æ‹©
        self.finish_time = -1                 # å®Œæˆè¿›ç«™æ—¶é—´
        self.is_finished = False              # æ˜¯å¦æˆåŠŸå®Œæˆ
```

**å…³é”®ç‰¹æ€§**ï¼š
- å®Œæ•´ç”Ÿå‘½å‘¨æœŸè¿½è¸ª
- å¤šç»´åº¦æ—¶é—´è®°å½•
- ä¸ªæ€§åŒ–è¡Œä¸ºæ ‡è®°

### 1.2 Simulationç±» - ä»¿çœŸä¸»æ§åˆ¶å™¨

```python
class Simulation:
    def __init__(self):
        self.env = simpy.Environment()        # SimPyä»¿çœŸç¯å¢ƒ
        self.random_state = np.random.RandomState(cfg.RANDOM_SEED)
        
        # èµ„æºå®šä¹‰
        self.security_lanes = [...]           # 12æ¡å®‰æ£€é€šé“
        self.north_lanes = [...]              # åŒ—ä¾§6æ¡é€šé“
        self.south_lanes = [...]              # å—ä¾§6æ¡é€šé“
        self.escalator = simpy.Resource(...)  # æ‰¶æ¢¯èµ„æº
        self.stairs = simpy.Resource(...)     # æ¥¼æ¢¯èµ„æºï¼ˆæ— é™å®¹é‡ï¼‰
        
        # æ•°æ®æ”¶é›†
        self.spectator_stats = []             # æ‰€æœ‰è§‚ä¼—æ•°æ®
        self.system_state_log = []            # ç³»ç»ŸçŠ¶æ€ç›‘æ§æ•°æ®
```

**æ¶æ„äº®ç‚¹**ï¼š
- èµ„æºæ± ç®¡ç†ï¼ˆå®‰æ£€é€šé“ã€æ‰¶æ¢¯ã€æ¥¼æ¢¯ï¼‰
- å—åŒ—åˆ†åŒºç­–ç•¥
- åŒé‡æ•°æ®æ”¶é›†æœºåˆ¶

---

## ğŸ¯ 2. ä»¿çœŸåˆå§‹åŒ–æµç¨‹

### 2.1 è§‚ä¼—ç”Ÿæˆç­–ç•¥

```python
def setup(self):
    self.env.process(self.monitor())          # å¯åŠ¨ç³»ç»Ÿç›‘æ§å™¨
    for i in range(cfg.TOTAL_SPECTATORS):    # ç”Ÿæˆ35,000åè§‚ä¼—
        # è§‚ä¼—åœ¨3.5å°æ—¶å†…å‡åŒ€éšæœºåˆ°è¾¾
        arrival_time = self.random_state.uniform(0, cfg.SIMULATION_DURATION_SECONDS)
        self.env.process(self.spectator_arrival(i, arrival_time))
```

**å…³é”®è®¾è®¡å†³ç­–**ï¼š
- **å‡åŒ€åˆ†å¸ƒåˆ°è¾¾**ï¼šæ¨¡æ‹Ÿè§‚ä¼—åœ¨æ•´ä¸ªæ—¶é—´çª—å£å†…æŒç»­åˆ°è¾¾
- **ç‹¬ç«‹è¿›ç¨‹**ï¼šæ¯ä¸ªè§‚ä¼—éƒ½æ˜¯ç‹¬ç«‹çš„ä»¿çœŸè¿›ç¨‹ï¼Œæ”¯æŒå¹¶å‘å¤„ç†
- **ç¡®å®šæ€§éšæœº**ï¼šä½¿ç”¨å›ºå®šéšæœºç§å­ç¡®ä¿ç»“æœå¯å¤ç°

### 2.2 å¹¶å‘æ§åˆ¶æœºåˆ¶

- **35,000ä¸ªè§‚ä¼—è¿›ç¨‹**ï¼šæ¯ä¸ªè§‚ä¼—ç‹¬ç«‹å¹¶å‘æ‰§è¡Œå®Œæ•´æµç¨‹
- **1ä¸ªç›‘æ§è¿›ç¨‹**ï¼šå®šæœŸè®°å½•ç³»ç»ŸçŠ¶æ€å¿«ç…§
- **SimPyäº‹ä»¶è°ƒåº¦å™¨**ï¼šè‡ªåŠ¨å¤„ç†æ—¶é—´æ¨è¿›å’Œèµ„æºç«äº‰

---

## ğŸ‘¥ 3. å•ä¸ªè§‚ä¼—å®Œæ•´æµç¨‹

### 3.1 é˜¶æ®µ1ï¼šäº¤é€šå»¶è¿Ÿæ¨¡æ‹Ÿ

```python
def get_transport_delay(self):
    # æ ¹æ®æ¦‚ç‡åˆ†å¸ƒé€‰æ‹©äº¤é€šæ–¹å¼
    mode = self.random_state.choice(
        list(cfg.TRANSPORT_PROBS.keys()), 
        p=list(cfg.TRANSPORT_PROBS.values())
    )
    
    delay = 0
    if mode == "è‡ªé©¾":
        # æ­£æ€åˆ†å¸ƒï¼šå‡å€¼5åˆ†é’Ÿï¼Œæ ‡å‡†å·®2åˆ†é’Ÿ
        delay = self.random_state.normal(cfg.DRIVE_DELAY_MEAN_S, cfg.DRIVE_DELAY_STD_S)
    elif mode == "å…¬äº¤":
        # å‡åŒ€åˆ†å¸ƒï¼š0-8åˆ†é’Ÿ
        delay = self.random_state.uniform(cfg.BUS_DELAY_MIN_S, cfg.BUS_DELAY_MAX_S)
    
    return max(0, delay)
```

**äº¤é€šæ–¹å¼æ¦‚ç‡åˆ†å¸ƒ**ï¼š
- è‡ªé©¾ï¼š30% â†’ æ­£æ€åˆ†å¸ƒå»¶è¿Ÿ
- å…¬äº¤ï¼š40% â†’ å‡åŒ€åˆ†å¸ƒå»¶è¿Ÿ
- å‡ºç§Ÿè½¦ï¼š15% â†’ æ— å»¶è¿Ÿ
- æ­¥è¡Œï¼š10% â†’ æ— å»¶è¿Ÿ
- è‡ªè¡Œè½¦ï¼š5% â†’ æ— å»¶è¿Ÿ

### 3.2 é˜¶æ®µ2ï¼šå…¬å›­å†…æ­¥è¡Œ

```python
def get_path_details(self):
    # è·¯å¾„é•¿åº¦ï¼š100-500ç±³å‡åŒ€åˆ†å¸ƒ
    path_length = self.random_state.uniform(cfg.PATH_LENGTH_MIN_M, cfg.PATH_LENGTH_MAX_M)
    # éšæœºæ‰°åŠ¨ï¼š1-3åˆ†é’Ÿå‡åŒ€åˆ†å¸ƒ
    random_delay = self.random_state.uniform(cfg.PATH_DISTURBANCE_MIN_S, cfg.PATH_DISTURBANCE_MAX_S)
    return path_length, random_delay

# åœ¨spectator_processä¸­æ‰§è¡Œï¼š
path_length, stats.walk_delay_random = self.get_path_details()
stats.walk_duration = path_length / cfg.BASE_WALKING_SPEED_MPS  # åŸºç¡€æ­¥è¡Œæ—¶é—´
yield self.env.timeout(stats.walk_duration)                    # æ‰§è¡Œæ­¥è¡Œ
yield self.env.timeout(stats.walk_delay_random)                # éšæœºæ‰°åŠ¨
```

**æ­¥è¡Œæ¨¡å‹å‚æ•°**ï¼š
- **åŸºç¡€é€Ÿåº¦**ï¼š1.2ç±³/ç§’
- **è·¯å¾„é•¿åº¦**ï¼š100-500ç±³ï¼ˆå‡åŒ€åˆ†å¸ƒï¼‰
- **éšæœºæ‰°åŠ¨**ï¼š1-3åˆ†é’Ÿï¼ˆæ¨¡æ‹Ÿæ„å¤–æƒ…å†µã€æ‹ç…§ç­‰ï¼‰

### 3.3 é˜¶æ®µ3ï¼šæ™ºèƒ½å®‰æ£€å¤§æ£šé€‰æ‹©

```python
# 3.1 å¤§æ£šçº§åˆ«é€‰æ‹©ï¼šæ¯”è¾ƒå—åŒ—ä¸¤ä¸ªå¤§æ£šçš„æ€»æ’é˜Ÿäººæ•°
north_queue = sum(len(res.queue) for res in self.north_lanes)
south_queue = sum(len(res.queue) for res in self.south_lanes)
chosen_tent_lanes = self.north_lanes if north_queue <= south_queue else self.south_lanes

# 3.2 é€šé“çº§åˆ«é€‰æ‹©ï¼šåœ¨é€‰å®šå¤§æ£šå†…é€‰æ‹©æ’é˜Ÿæœ€å°‘çš„å…·ä½“é€šé“
chosen_lane = min(chosen_tent_lanes, key=lambda r: len(r.queue))
```

**æ™ºèƒ½è°ƒåº¦ç®—æ³•**ï¼š
1. **ç¬¬ä¸€å±‚å†³ç­–**ï¼šå—åŒ—å¤§æ£šé€‰æ‹©
   - å®æ—¶æ¯”è¾ƒä¸¤ä¸ªå¤§æ£šçš„æ€»æ’é˜Ÿäººæ•°
   - é€‰æ‹©æ’é˜Ÿäººæ•°å°‘çš„å¤§æ£š
2. **ç¬¬äºŒå±‚å†³ç­–**ï¼šå…·ä½“é€šé“é€‰æ‹©
   - åœ¨é€‰å®šå¤§æ£šå†…æ¯”è¾ƒå„é€šé“æ’é˜Ÿæƒ…å†µ
   - é€‰æ‹©æ’é˜Ÿæœ€å°‘çš„é€šé“
3. **åŠ¨æ€æ›´æ–°**ï¼šæ¯ä¸ªè§‚ä¼—åˆ°è¾¾æ—¶é‡æ–°è¯„ä¼°

### 3.4 é˜¶æ®µ4ï¼šå¤æ‚å®‰æ£€å¤„ç†è¿‡ç¨‹

```python
with chosen_lane.request() as request:
    yield request  # æ’é˜Ÿç­‰å¾…é€šé“å¯ç”¨
    stats.security_queue_wait_time = self.env.now - security_queue_start_time
    
    security_process_start_time = self.env.now
    
    # å®‰æ£€å¤±è´¥é‡è¯•å¾ªç¯
    while self.random_state.rand() < cfg.SECURITY_FAILURE_RATE:
        process_time = self.random_state.exponential(cfg.SECURITY_CHECK_TIME_MEAN_S)
        yield self.env.timeout(process_time)  # å¤±è´¥å¤„ç†æ—¶é—´

    # æ­£å¸¸å®‰æ£€å¤„ç†
    process_time = self.random_state.exponential(cfg.SECURITY_CHECK_TIME_MEAN_S)
    yield self.env.timeout(process_time)
    
    stats.security_process_time = self.env.now - security_process_start_time

    # é€šé“æ•…éšœå¤„ç†
    if self.random_state.rand() < cfg.LANE_FAILURE_PROB_PER_PERSON:
        failure_duration = self.random_state.uniform(
            cfg.LANE_FAILURE_DURATION_MIN_S,
            cfg.LANE_FAILURE_DURATION_MAX_S
        )
        yield self.env.timeout(failure_duration)  # æ•…éšœæ¢å¤æ—¶é—´
```

**å®‰æ£€å¤„ç†çš„å¤šå±‚å¤æ‚æ€§**ï¼š
1. **æ’é˜Ÿç­‰å¾…**ï¼šä½¿ç”¨SimPyèµ„æºç®¡ç†å™¨å¤„ç†æ’é˜Ÿé€»è¾‘
2. **å¤±è´¥é‡è¯•**ï¼š2%æ¦‚ç‡å®‰æ£€å¤±è´¥ï¼Œéœ€è¦ç«‹å³é‡æ–°å®‰æ£€
3. **æ­£å¸¸å¤„ç†**ï¼šæŒ‡æ•°åˆ†å¸ƒæ—¶é—´ï¼ˆå‡å€¼15ç§’ï¼‰
4. **è®¾å¤‡æ•…éšœ**ï¼š0.1%æ¦‚ç‡é€šé“æ•…éšœï¼Œåœç”¨2-10åˆ†é’Ÿ

### 3.5 é˜¶æ®µ5ï¼šåŠ¨æ€ä¸‹è¡Œæ–¹å¼é€‰æ‹©

```python
# åˆå§‹æ¦‚ç‡è®¾ç½®
use_escalator_prob = cfg.DESCEND_INITIAL_PROBS['escalator']  # 40%

# åŠ¨æ€æ¦‚ç‡è°ƒæ•´
if len(self.escalator.queue) > cfg.ESCALATOR_QUEUE_THRESHOLD_FOR_ADJUST:
    use_escalator_prob = cfg.DESCEND_ADJUSTED_PROBS['escalator']  # é™è‡³30%

# æ ¹æ®è°ƒæ•´åæ¦‚ç‡é€‰æ‹©ä¸‹è¡Œæ–¹å¼
if self.random_state.rand() < use_escalator_prob:
    # é€‰æ‹©æ‰¶æ¢¯
    stats.descend_method = "escalator"
    with self.escalator.request() as request:
        yield request
        stats.descend_queue_wait_time = self.env.now - descend_queue_start_time
        descend_process_start_time = self.env.now
        yield self.env.timeout(1 / cfg.ESCALATOR_CAPACITY_PER_SEC)
        stats.descend_process_time = self.env.now - descend_process_start_time
else:
    # é€‰æ‹©æ¥¼æ¢¯
    stats.descend_method = "stairs"
    with self.stairs.request() as request:
        yield request
        stats.descend_queue_wait_time = self.env.now - descend_queue_start_time
        descend_process_start_time = self.env.now
        yield self.env.timeout(cfg.STAIRS_PERSON_CROSS_TIME_S)
        stats.descend_process_time = self.env.now - descend_process_start_time
```

**åŠ¨æ€å†³ç­–æœºåˆ¶**ï¼š
- **åˆå§‹çŠ¶æ€**ï¼šæ‰¶æ¢¯40%ï¼Œæ¥¼æ¢¯60%
- **æ‹¥å µè°ƒæ•´**ï¼šæ‰¶æ¢¯é˜Ÿåˆ—>50äººæ—¶ï¼Œæ‰¶æ¢¯æ¦‚ç‡é™è‡³30%ï¼Œæ¥¼æ¢¯å‡è‡³70%
- **å®æ—¶æ„ŸçŸ¥**ï¼šæ¯ä¸ªè§‚ä¼—éƒ½èƒ½æ„ŸçŸ¥å½“å‰é˜Ÿåˆ—çŠ¶æ€å¹¶æ™ºèƒ½å†³ç­–

---

## ğŸ“Š 4. ç³»ç»Ÿç›‘æ§æœºåˆ¶

### 4.1 å®æ—¶çŠ¶æ€ç›‘æ§

```python
def monitor(self):
    """å®šæœŸè®°å½•ç³»ç»ŸçŠ¶æ€å¿«ç…§"""
    while True:
        state = {
            "æ—¶é—´(s)": self.env.now,
            "åŒ—ä¾§å®‰æ£€é˜Ÿåˆ—æ€»äººæ•°": sum(len(r.queue) for r in self.north_lanes),
            "å—ä¾§å®‰æ£€é˜Ÿåˆ—æ€»äººæ•°": sum(len(r.queue) for r in self.south_lanes),
            "åŒ—ä¾§å®‰æ£€åŒºä½¿ç”¨ä¸­é€šé“æ•°": sum(r.count for r in self.north_lanes),
            "å—ä¾§å®‰æ£€åŒºä½¿ç”¨ä¸­é€šé“æ•°": sum(r.count for r in self.south_lanes),
            "ç”µæ¢¯é˜Ÿåˆ—äººæ•°": len(self.escalator.queue),
            "ç”µæ¢¯ä½¿ç”¨ä¸­äººæ•°": self.escalator.count,
            "æ¥¼æ¢¯ä½¿ç”¨ä¸­äººæ•°": self.stairs.count,
            "æ¥¼æ¢¯å¯†åº¦(äºº/ç±³)": self.stairs.count / cfg.STAIRS_WIDTH_M
        }
        self.system_state_log.append(state)
        yield self.env.timeout(cfg.MONITOR_INTERVAL_S)  # æ¯60ç§’è®°å½•ä¸€æ¬¡
```

### 4.2 ç›‘æ§æŒ‡æ ‡ä½“ç³»

**é˜Ÿåˆ—ç›‘æ§**ï¼š
- å—åŒ—å®‰æ£€åŒºé˜Ÿåˆ—é•¿åº¦
- æ‰¶æ¢¯æ’é˜Ÿäººæ•°
- å®æ—¶é˜Ÿåˆ—çŠ¶æ€å˜åŒ–

**èµ„æºåˆ©ç”¨ç‡**ï¼š
- å®‰æ£€é€šé“ä½¿ç”¨ç‡
- æ‰¶æ¢¯åˆ©ç”¨ç‡
- æ¥¼æ¢¯äººæµå¯†åº¦

**ç³»ç»Ÿæ€§èƒ½**ï¼š
- æ—¶é—´åºåˆ—æ•°æ®
- å³°å€¼è´Ÿè½½ç»Ÿè®¡
- ç“¶é¢ˆè¯†åˆ«æŒ‡æ ‡

---

## ğŸ”„ 5. ä»¿çœŸæ‰§è¡Œæµç¨‹

### 5.1 ä¸»æ§åˆ¶å¾ªç¯

```python
def run(self):
    """è¿è¡Œå®Œæ•´ä»¿çœŸ"""
    print("ä»¿çœŸå¼€å§‹...")
    self.setup()                                    # åˆå§‹åŒ–æ‰€æœ‰è§‚ä¼—å’Œç›‘æ§å™¨
    self.env.run(until=cfg.SIMULATION_DURATION_SECONDS)  # è¿è¡Œ3.5å°æ—¶ä»¿çœŸ
    print("ä»¿çœŸç»“æŸã€‚")
```

### 5.2 äº‹ä»¶è°ƒåº¦æœºåˆ¶

**SimPyç¦»æ•£äº‹ä»¶è°ƒåº¦**ï¼š
- è‡ªåŠ¨æ—¶é—´æ¨è¿›
- äº‹ä»¶ä¼˜å…ˆçº§ç®¡ç†
- èµ„æºç«äº‰å¤„ç†
- å¹¶å‘è¿›ç¨‹åè°ƒ

**è¿›ç¨‹ç®¡ç†**ï¼š
- 35,000ä¸ªè§‚ä¼—è¿›ç¨‹å¹¶å‘è¿è¡Œ
- 1ä¸ªç³»ç»Ÿç›‘æ§è¿›ç¨‹
- åŠ¨æ€èµ„æºåˆ†é…å’Œé‡Šæ”¾

---

## ğŸ“ˆ 6. æ•°æ®æ”¶é›†å’Œè¾“å‡º

### 6.1 ä¸ªä½“æ•°æ®æ”¶é›†

```python
def to_dict(self):
    """å°†è§‚ä¼—æ•°æ®è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
    return {
        "ID": self.id,
        "åˆ°è¾¾å…¬å›­æ—¶é—´": self.arrival_time,
        "äº¤é€šå»¶è¿Ÿ": self.transport_delay,
        "æ­¥è¡Œæ—¶é•¿": self.walk_duration,
        "å®‰æ£€æ’é˜Ÿæ—¶é•¿": self.security_queue_wait_time,
        "å®‰æ£€å¤„ç†æ—¶é•¿": self.security_process_time,
        "ä¸‹æ¥¼æ’é˜Ÿæ—¶é•¿": self.descend_queue_wait_time,
        "ä¸‹æ¥¼è¿‡ç¨‹æ—¶é•¿": self.descend_process_time,
        "ä¸‹è¡Œæ–¹å¼": self.descend_method,
        "å®Œæˆè¿›ç«™æ—¶é—´": self.finish_time,
        "æ˜¯å¦åœ¨è§„å®šæ—¶é—´å†…å®Œæˆ": self.is_finished,
        "æ€»è€—æ—¶": self.total_time()
    }
```

### 6.2 æ•°æ®è¾“å‡ºæ ¼å¼

```python
def get_results(self):
    """ç”Ÿæˆåˆ†æç”¨çš„DataFrame"""
    spectator_df = pd.DataFrame([s.to_dict() for s in self.spectator_stats])
    system_df = pd.DataFrame(self.system_state_log)
    return spectator_df, system_df
```

**è¾“å‡ºæ–‡ä»¶ç»“æ„**ï¼š
- `spectator_df`ï¼š35,000è¡Œè§‚ä¼—ä¸ªä½“æ•°æ®
- `system_df`ï¼šç³»ç»ŸçŠ¶æ€æ—¶é—´åºåˆ—æ•°æ®
- Excelå¤šå·¥ä½œè¡¨è¾“å‡ºæ ¼å¼

---

